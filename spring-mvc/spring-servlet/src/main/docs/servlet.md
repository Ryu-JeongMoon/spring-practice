# Servlet

바닥부터 직접 WAS 구현하려면 TCP/IP 통신, HTTP 메세지 파싱 등 비지니스 로직과 관련 없는 처리까지 전부 해야하는데  
개발자는 로직에 집중하고 나머지는 전부 공통화 시켜 놓은 것이 Servlet이다

자바에서는 HttpServlet 클래스를 상속 받고 구현하라고 만들어 놓은 doGet, doPost 등에 로직만 구현해놓으면 실행된다  
프레임워크란 요런 것이다, 귀찮은 부분을 전부 공통화 시켜놓고  
프레임워크가 지정해둔 흐름만 따라오면 개발자는 로직에만 집중할 수 있게 해준다

Servlet을 지원하는 WAS를 Servlet Container라 한다  
대표적으로 Tomcat, Jetty, Undertow 등이 있고 얘네는 Servlet의 생명주기를 관리해준다  
Servlet 객체를 싱글톤으로 만들어 놓고 고객 요청에 따라 실행되므로 공유 변수 사용에 매우 주의해야 한다  
JSP도 Servlet으로 변환되어 실행된다?!

Client - Server 구조에서 요청을 처리하는 스레드가 단 하나만 있다면 클라이언트가 많아질수록 응답 시간 지연이 늘어난다  
이를 해결하기 위해 초기에는 CGI를 이용해 멀티 프로세스로 처리했는데 프로세스는 생성 비용이 매우매우 비싸고 무한정 늘릴 수도 없다  
프로세스보다 작은 단위의 실행 흐름인 스레드를 이용해 멀티 스레드로 처리하는 것으로 진화했다  
대부분의 WAS는 멀티 스레드를 지원하여 개발자가 직접 동시성 로직을 작성하지 않아도 여러 요청을 처리할 수 있게 해준다  
Concurrent Programming은 어려워서 대가리가 깨질 수 있다  
WAS가 해준다고 막 짜면 안 되고 공유 변수 사용에 주의를 기울여야 한다

스레드 또한 생성, 수거 비용이 저렴하지 않기 때문에 요청이 올 때마다 생성하는 것은 비효율적이라 미리 여러 개를 만들어놓고 관리한다    
이를 스레드 풀이라 하며 톰캣의 기본 설정은 최대 200개다, 단순 스레드 풀도 요청이 많아지면 문제가 발생한다  
스레드 풀로 만들어 놔도 처리 시간이 제각기 다른데 먼저 끝났다고 해서 다른 작업을 도와주지 않는다  
이렇게 되면 가장 긴 시간이 걸리는 작업에 의해 실행 시간이 결정되는데 이 또한 비효율적이다  
개선하기 위해 Java7 이상에서는 Fork-Join Framework를 활용한 스레드 풀을 제공한다  
잘라서 (fork) 분배해주고 결과가 다 나오면 합쳐서 (join) 반환한다  
일이 먼저 끝난 스레드는 다른 스레드의 작업을 훔쳐와 마저 처리하여 전체 효율이 향상된다

적절한 스레드 풀의 최대 개수가 서버의 중요한 튜닝 포인트다  
너무 적다면 CPU 사용 안 하고 띵가띵가 노는 상태, 너무 많다면 처리는 못 하는데 요청만 다 받아버리는 상태  
nGrinder 같은 성능 테스트를 반드시 해봐야한다

<hr/>
``
암달의 법칙은 이렇다.
“멀티코어를 사용하는 프로그램의 속도는 프로그램 내부에 존재하는 sequential, 순차적 부분이 사용하는 시간에 의해서 제한된다.”
Thread나 Task를 만들어서 ExecutorService에게 제출하는 식으로 동시성 코드를 작성하면 여러 개의 스레드가 동시에 작업을 수행한다.
하지만 프로그램 안에는 Thread나 Task가 포함하지 않는 코드가 존재한다.
여러 개의 스레드가 동시에 작업을 수행하더라도 synchronized 블록이나 데이터베이스, 네트워크 API 호출 등을 만날 때
다른 스레드와 나란히 줄을 서서 순차적으로 작업을 수행 해야 하는 경우도 있다.
암달의 법칙은 프로그램이 낼 수 있는 속도의 상한이 이런 순차적 코드가 사용하는 시간에 의해서 제한된다고 말하는 것이다.
이러한 순차적 코드의 또 다른 이름은 blocking, 블로킹 콜이다.
문제는 스레드 자체 가 아니라 스레드를 사용하면서 자기도 모르게 만들어내는 블로킹 콜이다.
조금 과장해서 말하자면 자바 개발자가 스레드를 이용해서 만들어내는 ‘동시성’ 코드는 일종의 신기루다.
사실은 코드 곳곳에 존재하는 블로킹 콜, 순차적 코드 때문에 전 체적인 프로그램의 처리율은 이미 상한이 정해져 있지만
여러 개의 스레드가 ‘동시에’ 동작한다는 사실로부터 위안을 받을 뿐이다.
``

< 참조 >  
[1] : https://hamait.tistory.com/612  
[2] : https://velog.io/@agugu95/%EC%9E%90%EB%B0%94%EC%99%80-%EC%93%B0%EB%A0%88%EB%93%9C%ED%92%80-%EC%93%B0%EB%A0%88%EB%93%9C%EC%9D%98-%EC%83%9D%EC%84%B1%EB%B9%84%EC%9A%A9  
[3] : https://stackoverflow.com/questions/5483047/why-is-creating-a-thread-said-to-be-expensive